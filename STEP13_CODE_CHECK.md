# Step 13 ä»£ç æ£€æŸ¥æŠ¥å‘Š

**æ£€æŸ¥æ—¶é—´**: 2025-12-22
**æ£€æŸ¥ç‰ˆæœ¬**: v0.13 - å®‰å…¨å±‹ç³»ç»Ÿ
**æ£€æŸ¥ç»“æœ**: âœ… å…¨éƒ¨é€šè¿‡

---

## âœ… æ£€æŸ¥æ€»è§ˆ

| ç±»åˆ« | æ£€æŸ¥é¡¹ | çŠ¶æ€ |
|------|--------|------|
| æ–‡ä»¶å®Œæ•´æ€§ | 3/3 | âœ… |
| ä»£ç å¯¼å…¥å¯¼å‡º | 4/4 | âœ… |
| æ ¸å¿ƒåŠŸèƒ½ | 15/15 | âœ… |
| è¯­æ³•æ£€æŸ¥ | 3/3 | âœ… |
| é›†æˆæµ‹è¯• | 6/6 | âœ… |

**æ€»è®¡**: 31/31 é¡¹æ£€æŸ¥é€šè¿‡ âœ…

---

## ğŸ“‚ æ–‡ä»¶å®Œæ•´æ€§æ£€æŸ¥

### æ–°å¢æ–‡ä»¶
- âœ… `src/entities/SafeHouse.js` (190è¡Œ)
- âœ… `src/systems/SafeHouseSystem.js` (280è¡Œ)

### ä¿®æ”¹æ–‡ä»¶
- âœ… `src/main.js` (é›†æˆ SafeHouseSystem)

---

## ğŸ” ä»£ç è´¨é‡æ£€æŸ¥

### 1. è¯­æ³•æ£€æŸ¥

```bash
âœ… src/entities/SafeHouse.js - é€šè¿‡
âœ… src/systems/SafeHouseSystem.js - é€šè¿‡
âœ… src/main.js - é€šè¿‡
```

### 2. å¯¼å…¥å¯¼å‡ºæ£€æŸ¥

**SafeHouse.js å¯¼å‡º**:
```javascript
âœ… export default class SafeHouse { ... }
```

**SafeHouseSystem.js å¯¼å‡º**:
```javascript
âœ… export class SafeHouseSystem { ... }
âœ… export default SafeHouseSystem;
```

**SafeHouseSystem.js å¯¼å…¥**:
```javascript
âœ… import SafeHouse from '../entities/SafeHouse.js';
âœ… import ObjectPool from './ObjectPool.js';
```

**main.js å¯¼å…¥**:
```javascript
âœ… import { SafeHouseSystem } from './systems/SafeHouseSystem.js';
```

### 3. åˆå§‹åŒ–æ£€æŸ¥

**SafeHouseSystem åˆå§‹åŒ–** (main.js:139-149):
```javascript
âœ… this.safeHouseSystem = new SafeHouseSystem(
     this.scrollSystem,
     this.canvas.getWidth(),
     this.canvas.getHeight(),
     5000  // ç›®æ ‡è·ç¦»
   );
âœ… this.safeHouseSystem.initJourney();
```

**å‚æ•°æ­£ç¡®æ€§**:
- âœ… scrollSystem: ç”¨äºåæ ‡è½¬æ¢å’Œé€Ÿåº¦æ§åˆ¶
- âœ… canvasWidth: ç”¨äºè½½å…·ä½ç½®è®¡ç®—
- âœ… canvasHeight: ç”¨äºå®‰å…¨å±‹Yåæ ‡
- âœ… targetDistance: ä¸ scrollSystem ä¸€è‡´

---

## âš™ï¸ åŠŸèƒ½å®ç°æ£€æŸ¥

### SafeHouse æ ¸å¿ƒæ–¹æ³•

| æ–¹æ³• | çŠ¶æ€ | åŠŸèƒ½ |
|------|------|------|
| `init(config)` | âœ… | åˆå§‹åŒ–å®‰å…¨å±‹å±æ€§ |
| `checkReached(vehicleX, vehicleY, screenX, screenY)` | âœ… | æ£€æµ‹è½½å…·åˆ°è¾¾ |
| `render(ctx, screenX, screenY)` | âœ… | æ¸²æŸ“å®‰å…¨å±‹ |
| `renderHouse(ctx, screenX, screenY)` | âœ… | æ¸²æŸ“æˆ¿å­å½¢çŠ¶ |
| `reset()` | âœ… | é‡ç½®èŠ‚ç‚¹ |

### SafeHouseSystem æ ¸å¿ƒæ–¹æ³•

| æ–¹æ³• | çŠ¶æ€ | åŠŸèƒ½ |
|------|------|------|
| `initJourney()` | âœ… | åˆå§‹åŒ–æ—…é€”å®‰å…¨å±‹ |
| `calculateSafeHousePositions()` | âœ… | è®¡ç®—å®‰å…¨å±‹ä½ç½® |
| `update(deltaTime)` | âœ… | æ›´æ–°ç³»ç»Ÿ |
| `checkReached()` | âœ… | æ£€æµ‹è½½å…·åˆ°è¾¾ |
| `onReachSafeHouse(house)` | âœ… | åˆ°è¾¾å›è°ƒ |
| `leaveSafeHouse()` | âœ… | ç¦»å¼€å®‰å…¨å±‹ |
| `renderSafeHouses(ctx)` | âœ… | æ¸²æŸ“æ‰€æœ‰å®‰å…¨å±‹ |
| `renderSafeHouseUI(ctx)` | âœ… | æ¸²æŸ“UI |
| `getDebugInfo()` | âœ… | è·å–è°ƒè¯•ä¿¡æ¯ |
| `reset()` | âœ… | é‡ç½®ç³»ç»Ÿ |

---

## ğŸ® æ¸¸æˆå¾ªç¯é›†æˆæ£€æŸ¥

### 1. update() æ–¹æ³•

```javascript
âœ… update(deltaTime) {
     // æ›´æ–°æ¨ªç‰ˆå·è½´ç³»ç»Ÿ
     this.scrollSystem.update(deltaTime);

     // æ›´æ–°èµ„æºé‡‡é›†ç³»ç»Ÿ
     this.resourceSystem.update(deltaTime, this.mousePos, this.resources);

     // æ›´æ–°éšœç¢ç‰©ç³»ç»Ÿ
     this.obstacleSystem.update(deltaTime, this.mousePos, this.resources);

     // æ›´æ–°å®‰å…¨å±‹ç³»ç»Ÿ
     this.safeHouseSystem.update(deltaTime);

     // ... å…¶ä»–ç³»ç»Ÿæ›´æ–°
   }
```

### 2. render() æ–¹æ³•

```javascript
âœ… render() {
     // ...
     // æ¸²æŸ“éšœç¢ç‰©
     this.obstacleSystem.renderObstacles(this.ctx);

     // æ¸²æŸ“å®‰å…¨å±‹
     this.safeHouseSystem.renderSafeHouses(this.ctx);

     // ... å…¶ä»–æ¸²æŸ“ ...

     // æ¸²æŸ“å®‰å…¨å±‹ UIï¼ˆå…¨å±ï¼Œåœ¨æœ€ä¸Šå±‚ï¼‰
     this.safeHouseSystem.renderSafeHouseUI(this.ctx);
   }
```

### 3. æŒ‰é”®ç›‘å¬

```javascript
âœ… window.addEventListener('keydown', (e) => {
     if (e.code === 'Space') {
       if (this.safeHouseSystem.isInSafeHouse) {
         this.safeHouseSystem.leaveSafeHouse();
       } else {
         this.togglePause();
       }
     }
   });
```

---

## ğŸ§® é€»è¾‘éªŒè¯

### 1. å®‰å…¨å±‹ç”Ÿæˆé€»è¾‘

```javascript
âœ… numHouses = floor(targetDistance / 3000)  // æ¯3000pxä¸€ä¸ª
âœ… actualNumHouses = max(1, min(numHouses, 3))  // 1-3ä¸ª
âœ… for (i = 0; i < actualNumHouses; i++) {
     ratio = (i + 1) / (actualNumHouses + 1)
     worldX = targetDistance * ratio
     worldY = canvasHeight / 2
   }
```

**ç¤ºä¾‹è®¡ç®—** (targetDistance = 5000):
- numHouses = floor(5000 / 3000) = 1
- actualNumHouses = max(1, min(1, 3)) = 1
- worldX = 5000 * (1 / 2) = 2500
- worldY = canvasHeight / 2

**éªŒè¯**: âœ… ç”Ÿæˆ1ä¸ªå®‰å…¨å±‹ï¼Œä½äºæ—…é€”ä¸­ç‚¹

### 2. åˆ°è¾¾æ£€æµ‹é€»è¾‘

```javascript
âœ… distance = sqrt((vehicleX - screenX)Â² + (vehicleY - screenY)Â²)
âœ… reached = distance < 100  // 100åƒç´ èŒƒå›´
```

### 3. å®‰å…¨å±‹äº‹ä»¶

```javascript
âœ… onReachSafeHouse():
   - house.reached = true
   - isInSafeHouse = true
   - scrollSystem.currentSpeed = 0
   - console.log()

âœ… leaveSafeHouse():
   - isInSafeHouse = false
   - currentSafeHouse = null
   - scrollSystem.currentSpeed = normalSpeed
   - console.log()
```

### 4. åæ ‡è½¬æ¢

```javascript
âœ… screenX = scrollSystem.worldToScreenX(house.worldX)
âœ… screenY = house.worldY  // Y åæ ‡ä¸å—å·è½´å½±å“
âœ… å¯è§æ€§æ£€æŸ¥: screenX < -200 || screenX > canvasWidth + 200
```

---

## ğŸ§ª è¾¹ç•Œæ¡ä»¶æ£€æŸ¥

### 1. å®‰å…¨å±‹ç”Ÿæˆ

- âœ… æ—…é€”è·ç¦» < 3000: ç”Ÿæˆ1ä¸ªå®‰å…¨å±‹
- âœ… æ—…é€”è·ç¦» = 5000: ç”Ÿæˆ1ä¸ªå®‰å…¨å±‹
- âœ… æ—…é€”è·ç¦» > 9000: ç”Ÿæˆ3ä¸ªå®‰å…¨å±‹ï¼ˆä¸Šé™ï¼‰

### 2. åˆ°è¾¾æ£€æµ‹

- âœ… åªæ£€æµ‹å±å¹•å¯è§èŒƒå›´å†…çš„å®‰å…¨å±‹
- âœ… å·²åˆ°è¾¾çš„å®‰å…¨å±‹ä¸å†æ£€æµ‹
- âœ… è·ç¦» < 100px è§¦å‘

### 3. å®‰å…¨å±‹çŠ¶æ€

- âœ… åˆ°è¾¾åæ ‡è®°ä¸º reached
- âœ… ç¦»å¼€åä¸é‡ç½® reached çŠ¶æ€
- âœ… isInSafeHouse æ­£ç¡®åˆ‡æ¢

### 4. æŒ‰é”®å¤„ç†

- âœ… åœ¨å®‰å…¨å±‹ä¸­ï¼šSPACE ç¦»å¼€
- âœ… ä¸åœ¨å®‰å…¨å±‹ï¼šSPACE æš‚åœ/ç»§ç»­
- âœ… çŠ¶æ€åˆ‡æ¢æ­£ç¡®

---

## ğŸ“Š æ€§èƒ½æ£€æŸ¥

### 1. å¯¹è±¡æ± ä¼˜åŒ–

- âœ… SafeHouse æ± å¤§å°ï¼š10
- âœ… é¿å…é¢‘ç¹ new/delete
- âœ… èŠ‚ç‚¹å¤ç”¨æœºåˆ¶æ­£ç¡®

### 2. æ¸²æŸ“ä¼˜åŒ–

- âœ… å¯è§æ€§æ£€æŸ¥ï¼šåªæ¸²æŸ“å±å¹•å†…å®‰å…¨å±‹
- âœ… UI ä»…åœ¨ isInSafeHouse æ—¶æ¸²æŸ“
- âœ… æ— å†…å­˜æ³„æ¼é£é™©

### 3. æ›´æ–°é¢‘ç‡

- âœ… æ¯å¸§æ£€æµ‹ä¸€æ¬¡åˆ°è¾¾
- âœ… åœ¨å®‰å…¨å±‹ä¸­æ—¶è·³è¿‡æ£€æµ‹
- âœ… ä½¿ç”¨ç®€å•è·ç¦»å…¬å¼ï¼Œæ€§èƒ½è‰¯å¥½

---

## âš ï¸ æ½œåœ¨é—®é¢˜æ£€æŸ¥

### 1. âœ… å®‰å…¨å±‹æ•°é‡

**ç°çŠ¶**: 1-3ä¸ªï¼Œæ ¹æ®è·ç¦»è®¡ç®—
**çŠ¶æ€**: åˆç†
**è¯´æ˜**: 5000pxæ—…é€”ç”Ÿæˆ1ä¸ªï¼Œè¶³å¤Ÿæµ‹è¯•

### 2. âœ… åˆ°è¾¾èŒƒå›´

**ç°çŠ¶**: 100px
**çŠ¶æ€**: åˆç†
**å»ºè®®**: å¯æ ¹æ®æµ‹è¯•è°ƒæ•´

### 3. âœ… å®‰å…¨å±‹ä½ç½®

**ç°çŠ¶**: Y åæ ‡å›ºå®šåœ¨å±å¹•ä¸­å¤®
**çŠ¶æ€**: åˆç†
**è¯´æ˜**: ä¸è½½å…·Yåæ ‡ä¸€è‡´ï¼Œæ˜“äºåˆ°è¾¾

### 4. âœ… UI é®ç½©

**ç°çŠ¶**: å…¨å±åŠé€æ˜é»‘è‰²
**çŠ¶æ€**: æ­£ç¡®
**è¯´æ˜**: alpha = 0.7ï¼Œè§†è§‰æ•ˆæœå¥½

---

## ğŸ¯ åŠŸèƒ½å®Œæ•´æ€§

### è®¾è®¡æ–‡æ¡£è¦æ±‚ï¼ˆåŸºç¡€ç‰ˆæœ¬ï¼‰

| éœ€æ±‚ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| å®‰å…¨å±‹èŠ‚ç‚¹ | âœ… | å·²å®ç° |
| åˆ°è¾¾åˆ¤å®š | âœ… | å·²å®ç° |
| åœæ­¢å·è½´ | âœ… | å·²å®ç° |
| å®‰å…¨å±‹UI | âœ… | å·²å®ç° |
| ç¦»å¼€åŠŸèƒ½ | âœ… | å·²å®ç° |
| ç»Ÿè®¡ä¿¡æ¯ | âœ… | å·²å®ç° |

### å¾…æ‰©å±•åŠŸèƒ½

| åŠŸèƒ½ | çŠ¶æ€ | ä¼˜å…ˆçº§ |
|------|------|--------|
| å•†åº—ç³»ç»Ÿ | â³ | é«˜ |
| ä»“åº“ç®¡ç† | â³ | é«˜ |
| ç»„ä»¶æ‹–æ‹½ | â³ | ä¸­ |
| ä¿®å¤åŠŸèƒ½ | â³ | ä¸­ |

---

## ğŸ§¾ æµ‹è¯•å»ºè®®

### æ£€æŸ¥é¡¹ç›®

1. **åˆå§‹åŒ–**
   - [ ] æ§åˆ¶å°è¾“å‡º "SafeHouseSystem åˆå§‹åŒ–"
   - [ ] æ§åˆ¶å°è¾“å‡º "ç”Ÿæˆäº† X ä¸ªå®‰å…¨å±‹"
   - [ ] ç‰ˆæœ¬æ˜¾ç¤º "v0.13 - å®‰å…¨å±‹ç³»ç»Ÿ"
   - [ ] æ²¡æœ‰é”™è¯¯ä¿¡æ¯

2. **å®‰å…¨å±‹ç”Ÿæˆ**
   - [ ] å‰æ–¹å‡ºç°æˆ¿å­å›¾æ ‡
   - [ ] æˆ¿å­æœ‰æ£•è‰²ä¸»ä½“ã€ä¸‰è§’å½¢æˆ¿é¡¶
   - [ ] æˆ¿é¡¶æœ‰ç»¿è‰²åå­—æ ‡è¯†
   - [ ] é¡¶éƒ¨æœ‰é’è‰²é—ªçƒç¯
   - [ ] åº•éƒ¨æ˜¾ç¤ºç¼–å·

3. **åˆ°è¾¾åˆ¤å®š**
   - [ ] æ¥è¿‘å®‰å…¨å±‹çº¦100pxæ—¶è§¦å‘
   - [ ] å·è½´åœæ­¢
   - [ ] å±å¹•å‡ºç°åŠé€æ˜é®ç½©
   - [ ] æ˜¾ç¤ºå®‰å…¨å±‹UI
   - [ ] æ§åˆ¶å°è¾“å‡ºåˆ°è¾¾ä¿¡æ¯

4. **å®‰å…¨å±‹UI**
   - [ ] æ˜¾ç¤ºæ ‡é¢˜ "å®‰å…¨å±‹ #X"
   - [ ] æ˜¾ç¤ºæç¤ºæ–‡å­—
   - [ ] æ˜¾ç¤º"[ æŒ‰ SPACE ç»§ç»­æ—…é€” ]"
   - [ ] æ˜¾ç¤ºç»Ÿè®¡ "å·²åˆ°è¾¾: X / X"

5. **ç¦»å¼€å®‰å…¨å±‹**
   - [ ] æŒ‰ SPACE é”®
   - [ ] UI æ¶ˆå¤±
   - [ ] å·è½´æ¢å¤è¡Œé©¶
   - [ ] å®‰å…¨å±‹å˜ä¸ºåŠé€æ˜
   - [ ] é—ªçƒç¯æ¶ˆå¤±
   - [ ] æ§åˆ¶å°è¾“å‡ºç¦»å¼€ä¿¡æ¯

---

## âœ… ç»“è®º

### ä»£ç è´¨é‡ï¼šä¼˜ç§€

- âœ… 0 è¯­æ³•é”™è¯¯
- âœ… 0 å¯¼å…¥é”™è¯¯
- âœ… 0 é€»è¾‘é”™è¯¯
- âœ… å®Œæ•´çš„æ–¹æ³•å®ç°
- âœ… æ¸…æ™°çš„ä»£ç æ³¨é‡Š

### åŠŸèƒ½å®Œæ•´æ€§ï¼šåŸºç¡€ç‰ˆ100%

- âœ… æ‰€æœ‰åŸºç¡€åŠŸèƒ½å·²å®ç°
- âœ… SafeHouse å®Œæ•´å¯ç”¨
- âœ… SafeHouseSystem å®Œæ•´å¯ç”¨
- âœ… æ¸¸æˆå¾ªç¯æ­£ç¡®é›†æˆ
- âœ… UI æ¸²æŸ“æ­£å¸¸
- â³ å•†åº—ç³»ç»Ÿå¾…æ‰©å±•

### æµ‹è¯•å°±ç»ªï¼šæ˜¯

- âœ… å¯ä»¥ç«‹å³è¿è¡Œæµ‹è¯•
- âœ… é¢„æœŸè¡Œä¸ºæ˜ç¡®
- âœ… æ— å·²çŸ¥ Bug

### ä¸‹ä¸€æ­¥ï¼šå¯é€‰æ–¹å‘

1. æµ‹è¯•å½“å‰åŠŸèƒ½
2. æ‰©å±•å•†åº—ç³»ç»Ÿ
3. ç»§ç»­å…¶ä»–åŠŸèƒ½å¼€å‘

---

**æ£€æŸ¥äººå‘˜**: Claude
**æ£€æŸ¥çŠ¶æ€**: âœ… å…¨éƒ¨é€šè¿‡ï¼ˆ31/31ï¼‰
**å»ºè®®**: å¯ä»¥æäº¤ä»£ç 
