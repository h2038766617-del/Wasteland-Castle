# 🛠️ 开发指南

**项目**: Wasteland Castle
**最后更新**: 2026-01-12
**文档类型**: 开发流程和实践（涉及开发过程和计划）

---

## 📖 文档说明

本文档面向开发者，详细描述：
- 整体开发流程
- 具体开发计划
- 代码规范和最佳实践
- 问题处理流程

**相关文档**：
- [核心指导思想](./GUIDING_PRINCIPLES.md) - 必读，项目"宪法"
- [游戏设计文档](./DESIGN_DOC.md) - 游戏机制设计
- [测试清单](./TESTING_CHECKLIST.md) - 质量保证
- [架构文档](./ARCHITECTURE.md) - 代码结构

---

## 🎯 开发原则（精简版）

遵循[核心指导思想](./GUIDING_PRINCIPLES.md)，核心要点：

1. **质量至上** - 每次提交发布级别质量
2. **谨慎迭代** - 只改1-3个问题，充分测试
3. **问题即停** - 发现问题立即停止并修复
4. **冒烟测试强制** - 每次提交前必测

---

## 🔄 标准开发流程

### 完整开发循环

```
1. 接收任务/发现问题
   ↓
2. 阅读相关文档
   - 核心指导思想
   - 游戏设计文档
   - 相关代码架构
   ↓
3. 分析需求
   - 这个任务涉及哪些系统？
   - 可能会影响哪些功能？
   - 有哪些潜在风险？
   ↓
4. 制定计划
   - 需要修改哪些文件？
   - 分几步完成？（每步1-3个小问题）
   - 如何测试验证？
   ↓
5. 实施修改（小步快跑）
   - 第1步：修改 → 本地测试 → 提交
   - 第2步：修改 → 本地测试 → 提交
   - ...
   ↓
6. 完整验证
   - 冒烟测试清单
   - 完整游戏流程测试
   - 确认无新问题
   ↓
7. 提交和推送
   - 清晰的commit message
   - 更新相关文档
   ↓
8. 记录经验教训
   - 遇到了什么问题？
   - 如何解决的？
   - 有什么经验可以分享？
```

### 关键决策点

**在每个步骤都要问自己**：
- ✅ 我理解要做什么了吗？
- ✅ 我知道会影响哪些地方吗？
- ✅ 我的修改是最小的吗？
- ✅ 我测试过了吗？
- ✅ 我确定没引入新问题吗？

---

## 📋 开发前检查清单

### 开始工作前必须确认

```
✅ 我已经阅读了核心指导思想
✅ 我理解了游戏设计意图
✅ 我知道要修改哪些文件
✅ 我知道如何测试验证
✅ 我的修改范围足够小（1-3个问题）
✅ 我有清晰的完成标准
```

---

## 🧪 测试要求

### 冒烟测试（强制）

**每次提交前必须通过**：

```
✅ 游戏能启动吗？
✅ 能看到画面吗？
✅ 能看到光标吗？
✅ 能点击UI吗？
✅ 核心功能能用吗？
✅ 能完成一轮完整游戏流程吗？
```

详见 [测试清单](./TESTING_CHECKLIST.md)

### 功能测试

**针对修改的功能**：

1. **修改了什么功能** → 重点测试该功能
2. **影响了哪些系统** → 测试相关系统
3. **有没有边界情况** → 测试极端情况

**示例**：
```
修改：商店价格调整
功能测试：
  ✓ 购买最便宜的商品
  ✓ 购买最贵的商品
  ✓ 金币刚好够/不够
  ✓ 刷新商店后价格正确
  ✓ 购买后金币扣除正确
```

### 回归测试

**确保没有引入新问题**：

1. 完整游戏流程测试（MVP流程）
2. 之前修复过的问题没有复发
3. 相关功能没有异常

---

## 💻 代码规范

### 注释规范

**原则：简洁适中**

```javascript
// ❌ 不好：过度注释
let x = 5; // 设置x为5

// ✅ 好：注释"为什么"
let maxRetries = 5; // 限制重试次数，避免无限循环

// ✅ 好：复杂逻辑注释
// 计算邻接加成：遍历8个方向，检查相邻组件类型
function calculateAdjacencyBonus(component, grid) {
  // ...
}

// ❌ 不好：注释"是什么"
// 这个函数购买组件
function purchase(itemId, resources) {
  // ...
}

// ✅ 好：注释设计意图
/**
 * 购买商店商品
 * 注意：购买后立即从商店移除，防止重复购买
 */
function purchase(itemId, resources) {
  // ...
}
```

### 命名规范

**清晰胜于简洁**

```javascript
// ❌ 不好
let x = getE();
let tmp = calc(x);

// ✅ 好
let enemies = getActiveEnemies();
let totalDamage = calculateDamage(enemies);
```

**遵循项目约定**：
- 类名：PascalCase (`EnemySystem`)
- 函数/变量：camelCase (`calculateDamage`)
- 常量：UPPER_SNAKE_CASE (`MAX_ENEMIES`)
- 私有成员：下划线前缀 (`_internalState`)

### 文件组织

**遵循项目结构**：
```
src/
├── main.js              # 游戏主循环
├── entities/            # 实体类（组件、敌人等）
├── systems/             # 系统类（战斗、商店等）
├── ui/                  # UI系统
├── config/              # 配置常量
└── factories/           # 工厂类
```

**新增文件时**：
- 放在合适的目录
- 使用ES6 Modules导入导出
- 在main.js中正确引用

---

## 🐛 问题处理流程

### 发现问题时

**立即执行以下流程**：

```
1. 停止当前工作
   - 不要继续堆叠新代码
   - 不要"先这样，后面再修"
   ↓
2. 记录问题现象
   - 截图或录屏
   - 记录console输出
   - 记录重现步骤
   ↓
3. 分析根本原因
   - 不要只看表象
   - 使用浏览器调试工具
   - 检查相关代码
   ↓
4. 制定修复方案
   - 最小化修改
   - 考虑影响范围
   - 包含测试计划
   ↓
5. 实施修复
   - 修改代码
   - 本地测试
   - 确认问题解决
   ↓
6. 验证无新问题
   - 冒烟测试
   - 回归测试
   - 功能测试
   ↓
7. 提交修复
   - 清晰的commit message
   - 更新KNOWN_ISSUES.md
   - 记录FIX_HISTORY.md
   ↓
8. 总结经验
   - 为什么会出现这个问题？
   - 如何避免类似问题？
   - 需要更新文档吗？
```

### 问题优先级

**虽然所有问题最终都要解决，但处理顺序取决于当前阶段**：

**当前无法运行**：
- 优先：游戏启动、光标显示、基础交互
- 次要：其他所有问题

**已能运行，核心功能异常**：
- 优先：商店购买、战斗系统、组件放置
- 次要：体验优化、视觉效果

**已能玩，体验不好**：
- 优先：价格平衡、难度曲线、UI反馈
- 次要：动画细节、音效

### 问题分类

根据影响范围分类，帮助判断处理顺序：

| 分类 | 描述 | 示例 | 当前阶段处理 |
|------|------|------|--------------|
| **阻断性** | 游戏无法继续 | 光标不可见、游戏崩溃 | 立即修复 |
| **严重性** | 核心功能失效 | 购买失败、战斗异常 | 当天修复 |
| **一般性** | 功能可用但体验差 | 价格不平衡、UI不美观 | 本周修复 |
| **优化性** | 锦上添花 | 动画细节、音效缺失 | 待定 |

---

## 📝 提交规范

### Commit Message格式

**格式**：
```
<类型>：<简短描述>

<详细说明（可选）>

<关联信息（可选）>
```

**类型**：
- `修复` - Bug修复
- `功能` - 新功能
- `优化` - 性能或体验优化
- `重构` - 代码重构
- `文档` - 文档更新
- `测试` - 测试相关

**示例**：
```
修复：鼠标光标显示问题 - 核心交互问题

## 问题
index.html设置cursor: none，导致用户无法看到光标

## 修复
- index.html: 默认cursor改为default
- main.js: 在游戏状态切换时动态显示/隐藏光标
- SAFEHOUSE状态显示系统光标（可点击UI）
- JOURNEY状态隐藏系统光标（使用游戏内光标）

## 测试
✅ 启动游戏看到光标
✅ 可以点击商店
✅ 进入战斗光标切换
✅ 回到安全屋光标恢复
```

### 提交前检查

```
✅ 通过了冒烟测试
✅ 功能测试通过
✅ 回归测试通过
✅ 代码有适当注释
✅ Commit message清晰
✅ 相关文档已更新
✅ 没有引入新问题
```

---

## 📚 文档维护

### 何时更新文档

**强制更新**：
- 修改了游戏机制 → 更新DESIGN_DOC.md
- 发现新的指导原则 → 更新GUIDING_PRINCIPLES.md
- 修复了重要问题 → 更新FIX_HISTORY.md
- 发现已知问题 → 更新KNOWN_ISSUES.md

**建议更新**：
- 优化了开发流程 → 更新DEV_GUIDE.md
- 改进了架构 → 更新ARCHITECTURE.md
- 总结了经验 → 更新相关文档

### 文档更新流程

```
1. 识别需要更新的文档
2. 修改文档内容
3. 更新"最后更新"日期
4. 与代码修改一起提交
5. 通知相关人员（如有）
```

---

## 🎯 当前开发计划

### Phase 1: MVP完成（当前）

**目标：确保完整游戏流程可玩**

#### 待验证项
- [ ] 启动游戏 → 看到光标 ✅（已修复）
- [ ] 购买商品 → 金币扣除 → 进入仓库 ✅（已修复）
- [ ] 拖拽组件 → 放置到网格 → 邻接加成生效
- [ ] 进入战斗 → 炮塔攻击 → 击败敌人
- [ ] 完成旅途 → 获得奖励 → 回到安全屋

#### 已知问题
参见 [KNOWN_ISSUES.md](./issues/KNOWN_ISSUES.md)

### Phase 2: 平衡调优

**目标：游戏体验良好**

- [ ] 价格平衡验证
- [ ] 难度曲线调整
- [ ] 资源循环优化
- [ ] UI/UX改进

### Phase 3: 内容扩展

**目标：增加深度和多样性**

- [ ] 更多组件类型
- [ ] 成就系统
- [ ] 可选难度
- [ ] 音效和视觉效果增强

### Phase 4: 发布准备

**目标：可发布级别**

- [ ] 完整测试
- [ ] 性能优化
- [ ] 文档完善
- [ ] 打包和部署

---

## 🛠️ 常用开发工具

### 浏览器开发者工具

**Console**：
- 查看日志输出
- 调试代码
- 检查错误

**Elements**：
- 检查DOM结构
- 调试CSS
- 查看Canvas元素

**Sources**：
- 设置断点
- 单步调试
- 查看变量值

### 本地服务器

```bash
# Python 3
python -m http.server 8000

# Python 2
python -m SimpleHTTPServer 8000

# Node.js (如安装http-server)
http-server -p 8000

# 项目自带脚本
./START_SERVER.sh
```

### Git工作流

```bash
# 查看当前状态
git status

# 查看修改内容
git diff

# 添加文件
git add <file>

# 提交
git commit -m "类型：描述"

# 推送
git push origin <branch>

# 创建新分支
git checkout -b feature/new-feature
```

---

## 💡 最佳实践

### 开发技巧

1. **小步快跑**
   - 每次只改一点点
   - 立即测试验证
   - 确认无误再继续

2. **频繁提交**
   - 每个小改动都提交
   - Commit message清晰
   - 便于回滚和追踪

3. **使用Console**
   - 添加调试日志
   - 验证逻辑正确
   - 发现问题快速定位

4. **保持专注**
   - 一次只做一件事
   - 发现其他问题先记录
   - 当前任务完成再处理

### 常见陷阱

**❌ 避免**：
- 一次改动太多文件
- 跳过测试直接提交
- 假设功能正常工作
- "先这样，后面再修"
- 只测试正常情况

**✅ 应该**：
- 最小化修改范围
- 每次修改都测试
- 实际运行验证
- 立即修复问题
- 测试边界情况

---

## 🔍 调试技巧

### 常见问题调试

**光标不可见**：
```javascript
// 检查Canvas的cursor样式
console.log(canvas.style.cursor);

// 检查游戏状态
console.log(this.gameState);
```

**购买失败**：
```javascript
// 检查资源数量
console.log('Gold:', this.resources.gold);
console.log('Price:', item.price);

// 检查商品是否存在
console.log('Item:', this.shopSystem.getItems());
```

**组件放置失败**：
```javascript
// 检查网格位置
console.log('Grid pos:', gridX, gridY);
console.log('Is valid:', this.gridManager.isValidPosition(gridX, gridY));

// 检查组件状态
console.log('Component:', component);
```

### 性能调试

```javascript
// 测量函数执行时间
console.time('functionName');
// ... 代码 ...
console.timeEnd('functionName');

// 查看FPS
// 已在DEBUG模式下显示
```

---

## 📞 寻求帮助

### 遇到困难时

1. **先自己尝试**
   - 查看相关文档
   - 使用浏览器调试工具
   - 搜索类似问题

2. **记录问题**
   - 截图或录屏
   - 记录重现步骤
   - 记录尝试过的方法

3. **寻求帮助**
   - 提供清晰的问题描述
   - 附上相关截图和日志
   - 说明已尝试的解决方法

---

## 📋 总结

### 记住这些关键点

1. **质量 > 速度** - 慢一点但做对
2. **测试 > 假设** - 运行验证而非猜测
3. **小步 > 大步** - 渐进式改进
4. **文档 = 代码** - 同步维护

### 每日检查清单

**开始工作前**：
- [ ] 阅读核心指导思想
- [ ] 了解今天要做什么
- [ ] 知道如何测试验证

**工作中**：
- [ ] 小步快跑
- [ ] 频繁测试
- [ ] 发现问题立即停止

**结束工作时**：
- [ ] 通过冒烟测试
- [ ] 代码已提交
- [ ] 文档已更新

---

**遵循本指南，确保每次迭代都是真正的进步！**
