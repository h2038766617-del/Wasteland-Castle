# 🔧 修复历史

**项目**: Wasteland Castle
**最后更新**: 2026-01-12

本文档记录项目的重要修复历史，特别是那些有教育意义的修复。

---

## 📖 使用说明

### 记录标准

记录以下类型的修复：
- ✅ P0/P1级别的重要修复
- ✅ 有教育意义的修复（避免类似问题）
- ✅ 架构级别的修复
- ❌ 不记录小的UI调整、文档修改等

### 记录格式

每个修复包含：
- **标题** - 简短描述
- **日期** - 修复日期
- **优先级** - P0/P1/P2
- **问题描述** - 详细的问题说明
- **根本原因** - 为什么会出现这个问题
- **修复方法** - 如何解决的
- **经验教训** - 如何避免类似问题
- **相关Commit** - Git提交记录

---

## 🎯 2026-01-12 - 核心交互修复

### 修复1: 鼠标光标不可见 🔴 P0

**日期**: 2026-01-12
**优先级**: P0（阻断性）
**状态**: ✅ 已修复

#### 问题描述

用户反馈："连个鼠标光标都没有，怎么买东西？"

**症状**:
- 启动游戏后看不到鼠标光标
- 无法点击商店、修复面板
- 游戏完全无法交互
- **这是最致命的基础问题**

#### 根本原因

**技术原因**:
```html
<!-- index.html:23 -->
#gameCanvas {
  cursor: none; /* 隐藏了系统光标 */
}
```

**设计缺陷**:
- 游戏使用了自定义的`DroneCursor`（Canvas内绘制）
- Canvas内绘制的光标只是图像，**无法用于点击UI元素**
- 需要系统光标才能点击DOM或Canvas上的UI区域
- 但全局设置`cursor: none`导致光标永远不可见

**为什么会出现**:
- 最初设计时假设只使用游戏内自定义光标
- 没有考虑安全屋状态需要点击UI
- 没有从用户视角测试（启动游戏第一眼）

#### 修复方法

**核心思路：状态化光标管理**

1. **index.html**: 默认显示系统光标
```html
#gameCanvas {
  cursor: default; /* 默认显示 */
}
```

2. **main.js**: 动态切换光标

```javascript
// 游戏启动时（SAFEHOUSE）
start() {
  canvas.style.cursor = 'default';
  console.log('[光标] 游戏启动，已显示系统光标');
}

// 进入战斗时（JOURNEY）
startJourney() {
  canvas.style.cursor = 'none';
  console.log('[光标] 已切换到游戏内光标');
}

// 回到安全屋时
returnToSafeHouse() {
  canvas.style.cursor = 'default';
  console.log('[光标] 已切换到系统光标');
}

// 重启游戏时
restart() {
  canvas.style.cursor = 'default';
  console.log('[光标] 游戏重启，已显示系统光标');
}
```

**修改文件**:
- `index.html` - CSS修改
- `src/main.js` - 4处光标切换

#### 验证测试

```
✅ 启动游戏 → 光标可见
✅ 可以点击商店
✅ 可以购买商品
✅ 按Space进入战斗 → 光标切换为游戏内光标
✅ 回到安全屋 → 光标恢复
✅ 按R重启 → 光标可见
```

#### 经验教训

**重要教训** ⭐:
1. **不要假设基础功能正常** - 即使是"光标可见"也要验证
2. **用户视角优先** - 从"打开游戏第一眼"开始测试
3. **冒烟测试强制执行** - 每次提交前必须通过
4. **优先级至关重要** - P0问题必须立即修复，不能被P2/P3分心

**避免方法**:
- ✅ 每次修改后实际运行游戏
- ✅ 从用户视角完整体验
- ✅ 遵循冒烟测试清单
- ✅ 不假设任何功能是正常的

**相关文档**:
- [CRITICAL_FIX_CURSOR.md](../../CRITICAL_FIX_CURSOR.md) - 详细分析
- [GUIDING_PRINCIPLES.md](../GUIDING_PRINCIPLES.md) - 更新了指导原则

**Commit**:
```
0186289 - 修复：鼠标光标显示问题 - 核心交互问题
```

---

### 修复2: 商店价格过高和刷新死锁 🟡 P1

**日期**: 2026-01-12
**优先级**: P1（严重性）
**状态**: ✅ 已修复

#### 问题描述

**症状**:
- 初始金币50，大部分商品买不起（CORE 100金币）
- 买了几个便宜商品后，剩余金币不足10无法刷新
- 剩余商品买不起，陷入死锁
- **商店功能形同虚设**

**用户体验**:
```
进入商店 → 看到4个商品
  - CORE (common): 100金币 ❌ 买不起
  - WEAPON (uncommon): 45金币 ✓ 买得起
  - BOOSTER (uncommon): 60金币 ❌ 买不起
  - ARMOR (rare): 50金币 ❌ 买不起

购买1个WEAPON → 剩余5金币
  - 无法刷新（需要10金币）
  - 剩余商品都买不起
  - 被困住！
```

#### 根本原因

**经济设计缺陷**:

1. **初始金币太少**
   - 初始：50金币
   - 基础价格：CORE 100, WEAPON 30, ARMOR 25, BOOSTER 40
   - 品质倍数：uncommon ×1.5, rare ×2.0, epic ×3.0
   - **结果**：30-70%的商品买不起

2. **刷新成本过高**
   - 刷新：10金币
   - 购买几个商品后常常剩余<10金币
   - **死锁**：无法刷新，剩余商品买不起

3. **没有缓冲机制**
   - 没有免费刷新
   - 没有"退货"机制
   - 一旦陷入死锁，只能重启游戏

**为什么会出现**:
- 初始平衡未经实际测试
- 只看代码逻辑，未实际游玩
- 优先级倒置：先优化价格平衡，忽略了光标问题

#### 修复方法

**调整经济参数**:

1. **提高初始金币**
```javascript
// main.js
this.resources = {
  gold: 150  // 从50提升到150（3倍）
};
```

2. **降低商品价格**
```javascript
// ShopSystem.js
this.componentBasePrices = {
  CORE: 60,     // 从100降为60 (-40%)
  WEAPON: 20,   // 从30降为20 (-33%)
  ARMOR: 15,    // 从25降为15 (-40%)
  BOOSTER: 25   // 从40降为25 (-38%)
};
```

3. **降低刷新成本**
```javascript
// ShopSystem.js
this.refreshCost = 5;  // 从10降为5 (-50%)
```

**修改后的体验**:
```
初始金币：150
商品价格：CORE 60, WEAPON 20, ARMOR 15, BOOSTER 25
刷新成本：5

能购买：2-4个商品（包括CORE）
刷新压力：大幅降低
死锁概率：几乎为0
```

#### 额外改进：UI反馈

```javascript
// main.js - 购买边框
ctx.strokeStyle = canBuy ? '#00FF00' : '#FF0000';  // 绿色/红色
ctx.lineWidth = canBuy ? 2 : 1;

// 金币不足提示
if (!canBuy) {
  ctx.fillStyle = '#FF6666';
  ctx.fillText('(金币不足)', ...);
}

// 详细日志
console.log('✅ 购买成功！');
console.log(`   - 商品: ${component.type} (${component.quality})`);
console.log(`   - 剩余金币: ${this.resources.gold}`);
```

#### 验证测试

```
✅ 初始金币150
✅ 商品价格降低
✅ 可以购买多个商品
✅ 刷新成本5金币
✅ 不会出现死锁
✅ UI反馈清晰（绿色/红色边框）
```

#### 经验教训

**重要教训**:
1. **实际游玩验证** - 数值平衡必须实际测试
2. **用户体验优先** - "买不起"的感觉很糟糕
3. **避免死锁** - 任何资源管理系统都要考虑死锁
4. **缓冲机制** - 给玩家留有余地

**平衡设计原则**:
- 初始资源应该充足（让玩家有选择）
- 刷新成本应该低（鼓励探索）
- 避免"陷阱"（不可逆的错误决策）
- 提供明确反馈（买得起/买不起）

**相关文档**:
- [SHOP_ANALYSIS.md](../../SHOP_ANALYSIS.md) - 详细分析

**Commit**:
```
9862fb0 - 修复：商店购买核心问题
```

---

## 📊 修复统计

**截至 2026-01-12**:
- 总修复数：2个重要修复
- P0修复：1个（光标问题）
- P1修复：1个（商店经济）
- P2修复：0个
- P3修复：0个

---

## 🎯 重要修复模式

### 模式1: 基础交互优先

**案例**: 光标修复

**教训**:
- 在优化高级功能前，确保基础交互可用
- 冒烟测试必须包含最基础的检查
- 从用户视角第一眼开始测试

### 模式2: 经济平衡需实测

**案例**: 商店价格调整

**教训**:
- 数值平衡不能只靠理论
- 必须实际游玩验证
- 考虑死锁和极端情况

### 模式3: 优先级至关重要

**错误示例**: 先调整价格（P2），忽略光标问题（P0）

**正确做法**:
1. 先修复P0（光标）
2. 再修复P1（商店经济）
3. 最后优化P2（体验细节）

---

## 🔄 修复流程总结

### 标准修复流程

```
1. 发现问题
   ↓
2. 停止当前工作
   ↓
3. 分析根本原因
   - 不要只看表象
   - 深入理解为什么会出现
   ↓
4. 制定修复方案
   - 最小化修改
   - 考虑影响范围
   ↓
5. 实施修复
   - 修改代码
   - 添加日志
   ↓
6. 测试验证
   - 冒烟测试
   - 功能测试
   - 回归测试
   ↓
7. 提交记录
   - 清晰的commit message
   - 更新KNOWN_ISSUES.md
   - 记录FIX_HISTORY.md
   ↓
8. 总结经验
   - 为什么会出现？
   - 如何避免？
   - 更新指导原则
```

---

## 💡 关键经验总结

### 从光标和商店修复中学到的

1. **冒烟测试的重要性**
   - 如果有强制冒烟测试，光标问题会在第一时间发现
   - 测试清单必须包含最基础的检查

2. **用户视角的重要性**
   - 不能只看代码和逻辑
   - 必须从"第一次打开游戏"的角度测试

3. **优先级的重要性**
   - P0问题（无法交互）比P2问题（价格平衡）重要得多
   - 不能本末倒置

4. **实际测试的重要性**
   - 数值平衡不能只靠理论
   - 必须实际游玩

5. **文档的重要性**
   - 记录问题和修复过程
   - 避免重复犯错
   - 帮助新人理解

---

## 🔗 相关文档

- [已知问题](./KNOWN_ISSUES.md) - 当前待修复问题
- [核心指导思想](../GUIDING_PRINCIPLES.md) - 从修复中总结的原则
- [测试清单](../TESTING_CHECKLIST.md) - 发现问题的方法
- [开发指南](../DEV_GUIDE.md) - 问题处理流程

---

**记录历史，避免重复犯错！**
